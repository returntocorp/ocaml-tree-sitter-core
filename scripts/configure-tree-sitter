#! /usr/bin/env bash
#
# Determine locations of the tree-sitter C library and headers.
#
# Tries to support Ubuntu for x86_64, with either musl or glibc depending
# on [the name of] the opam setup.
#
set -eu

# Generate config files in shell and make formats.
config_sh=config.sh
config_mk=config.mk

error() {
  echo "Error: $*" >&2
  exit 1
}

which pkg-config > /dev/null || error "'pkg-config' command not found."
pkg-config tree-sitter || error "The tree-sitter library can't be found.
Consider installing it with './scripts/install-tree-sitter-lib'."

if [[ -z "${TREESITTER_INCDIR+x}" ]]; then
  TREESITTER_INCDIR=$(
    pkg-config --cflags-only-I tree-sitter \
    | sed -e 's/^-I//'
  )
fi
export TREESITTER_INCDIR

if [[ -z "${TREESITTER_LIBDIR+x}" ]]; then
  TREESITTER_LIBDIR=$(
    pkg-config --libs-only-L tree-sitter \
    | sed -e 's/^-L//'
  )
fi
export TREESITTER_LIBDIR

cat <<EOF
Config for using libtree-sitter:
  TREESITTER_INCDIR: $TREESITTER_INCDIR
  TREESITTER_LIBDIR: $TREESITTER_LIBDIR
Config file for bash: $config_sh
Config file for make: $config_mk
EOF

cat > "$config_sh" <<EOF
# Config for using libtree-sitter, generated by '$0' using pkg-config.

# Where the C headers get installed, in particular 'tree_sitter/api.h'.
TREESITTER_INCDIR="$TREESITTER_INCDIR"
export TREESITTER_INCDIR

# Where the tree-sitter runtime library gets installed.
TREESITTER_LIBDIR="$TREESITTER_LIBDIR"
export TREESITTER_LIBDIR
EOF

# There is a subtle difference with $config_sh:
# There is no use of double quotes. If we use double quotes
# our -I and -L generated from dune will be something like
# -I '"/abc/xyz"' . This obviously wont work
cat > "$config_mk" <<EOF
# Config for using libtree-sitter, generated by '$0' using pkg-config.

# Where the C headers get installed, in particular 'tree_sitter/api.h'.
TREESITTER_INCDIR=$TREESITTER_INCDIR
export TREESITTER_INCDIR

# Where the tree-sitter runtime library gets installed.
TREESITTER_LIBDIR=$TREESITTER_LIBDIR
export TREESITTER_LIBDIR
EOF
